<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
<!--  <PropertyGroup>-->
<!--    <ApiContractPackageVersion>0.10.0</ApiContractPackageVersion>-->
<!--    <NugetPackageName Condition="'$(PackageId)' != ''">$(PackageId)</NugetPackageName>-->
<!--    <NugetPackageName Condition="'$(PackageId)' == ''">Avalonia</NugetPackageName>-->
<!--    <RunApiCompat Condition="'$(TargetFramework)' == 'net6.0'">false</RunApiCompat>-->
<!--  </PropertyGroup>-->
<!--  <ItemGroup>-->
<!--    <PackageDownload Include="$(NugetPackageName)" Version="[$(ApiContractPackageVersion)]" />-->
<!--    <PackageReference Include="Microsoft.DotNet.ApiCompat" Version="5.0.0-beta.20372.2" PrivateAssets="All" />-->
<!--    <ResolvedMatchingContract Include="$(NuGetPackageRoot)\$(NugetPackageName.ToLowerInvariant())\$(ApiContractPackageVersion)\lib\$(TargetFramework)\$(AssemblyName).dll" />-->
<!--  </ItemGroup>-->
  
  <PropertyGroup>
    <IsShippingClientLibrary>true</IsShippingClientLibrary>
    <GenerateAPIListing Condition="'$(IsShippingClientLibrary)' == 'true'">true</GenerateAPIListing>
  </PropertyGroup>
  
  <ItemGroup>
    <PackageReference Include="Microsoft.DotNet.GenAPI" PrivateAssets="All" Version="7.0.0-beta.23060.4" />
  </ItemGroup>

  <!-- TODO move to targets -->
  <PropertyGroup>
    <_SupportsApiListing Condition="'$(IsShippingClientLibrary)' == 'true' AND '$(GenerateApiListingOnBuild)' == 'true'">true</_SupportsApiListing>
  </PropertyGroup>

  <Target
    Name="_GenerateApiListing"
    Condition="'$(_SupportsApiListing)' == 'true' AND '$(GenerateAPIListing)' == 'true'"
    AfterTargets="_GenerateApiListingAfterBuild"
    DependsOnTargets="GenerateReferenceAssemblySource" />

  <Target
    Name="_GenerateApiListingAfterBuild"
    AfterTargets="CoreBuild"
    Condition="'$(_SupportsApiListing)' == 'true'">

    <PropertyGroup>
      <_RefSourceOutputPath>$([System.IO.Directory]::GetParent('$(MSBuildThisFileDirectory)'))/../api/</_RefSourceOutputPath>
      <GenAPITargetPath>$(_RefSourceOutputPath)$(AssemblyName).$(TargetFramework).cs</GenAPITargetPath>
    </PropertyGroup>
    <Delete Files="$(GenAPITargetPath)" />
  </Target>

  <Target Name="_CheckGenerateAPIListingValue" AfterTargets="Build">
    <Error
      Condition="'$(IsShippingClientLibrary)' == 'true' AND '$(GenerateAPIListing)' != 'true' AND '$(HasReleaseVersion)' != 'false'"
      Text="GenerateAPIListing must be set to true for non preview version" />
  </Target>
</Project>
